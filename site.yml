---

- hosts: all
  remote_user: root
  tasks: 

    - name: Disable dpkg fsync
      raw: test -e /etc/dpkg/dpkg.cfg.d/unsafe-io || echo force-unsafe-io > /etc/dpkg/dpkg.cfg.d/unsafe-io

    - name: Upgrade debian
      apt:
        update_cache: true
        upgrade: true

    - name: Install required debs
      apt:
        name: 
          - dirmngr
          - apt-transport-https
          - aptitude
        state: latest 
        
    - name: Add x2go user
      user:
        name: x2go
        comment: X2Go User
        group: users
        groups: sudo
        generate_ssh_key: yes
        shell: /bin/bash

    - name: Add apt keys
      apt_key:
        keyserver: keys.gnupg.net
        id: "{{ item }}" 
      with_items:
        - E1F958385BFE2B6E
        - 1655A0AB68576280
        - 1C52189C923F6CA9
        - EB3E94ADBE1229CF

    - name: Add repos
      apt_repository: 
        repo: "{{item}}"
        state: present
      with_items:
        - deb http://packages.x2go.org/debian stretch extras main
        - deb https://deb.nodesource.com/node_12.x stretch main
        - deb http://ppa.launchpad.net/ethereum/ethereum/ubuntu xenial main
        - deb https://packages.microsoft.com/repos/vscode stable main

    - name: Install required debs
      apt:
        name: 
          - mate-desktop
          - x2goserver
          - mate-session-manager
          - mate-applets
          - mate-backgrounds
          - mate-control-center
          - mate-desktop-environment
          - dconf-cli
          - ethereum
          - nodejs
          - code
          - git
          - firefox-esr
          - openjdk-11-jdk
          - openssl
        state: latest

    - name: remove visual studio repo
      apt_repository: 
        repo: deb https://packages.microsoft.com/repos/vscode stable main
        state: absent
        update_cache: yes

    - name: install libkeccak.so
      copy: 
        src: ./files/libkeccak.so.1.2
        dest: /usr/local/lib

    - name: install keccac-256sum
      copy: 
        src: ./files/keccak-256sum
        dest: /usr/local/bin
        mode: "0775"

    - name: run ldconfig
      command: ldconfig

    - name: install besu binary
      unarchive:
        src: https://bintray.com/api/ui/download/hyperledger-org/besu-repo/besu-1.3.5.tar.gz
        dest: /usr/local
        owner: root
        remote_src: yes

    - name: link besu
      file:
        src: /usr/local/besu-1.3.5/bin/besu
        dest: /usr/local/bin/besu
        owner: root
        state: link
        
    - name: create local directories
      file:
        path: "{{ item }}" 
        recurse: yes
        state: directory
        owner: x2go
      with_items: 
        - /home/x2go/.config/autostart
        - /home/x2go/Desktop
        - /home/x2go/docs

    - name: copy check_wallpaper.sh
      copy:
        src: ./files/check_wallpaper.sh
        dest: /usr/local/bin
        mode: "0755"

    - name: copy check_wallpaper.desktop
      copy: 
        src: ./files/check_wallpaper.desktop
        dest: /home/x2go/.config/autostart
        owner: x2go
        group: users

    - name: copy wallpaper.jpg
      copy: 
        src: ./files/wallpaper.jpg
        dest: /home/x2go
        owner: x2go
        group: users

    - name: copy show_docs.sh
      copy:
        src: ./files/show_docs.sh
        dest: /usr/local/bin
        mode: "0755"

    - name: copy show_docs.desktop
      copy:
        src: ./files/show_docs.desktop
        dest: /home/x2go/.config/autostart
        owner: x2go
        group: users

    - name: copy docs
      copy:
        src: ./files/docs
        dest: /home/x2go/docs
        owner: x2go
        group: users

    - name: copy Mist.desktop
      copy: 
        src: ./files/Mist.desktop
        dest: /home/x2go/Desktop
        owner: x2go
        group: users

    - name: fix sudoers
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^%sudo"
        line: "%sudo ALL=NOPASSWD: ALL"

    - name: copy besu.service
      copy: 
        src: ./files/besu.service
        dest: /lib/systemd/system
      
    - name: copy besu.default
      copy: 
        src: ./files/besu.default
        dest: /etc/default/besu

    - name: copy start_besu
      copy: 
        src: ./files/start_besu
        dest: /usr/local/sbin/start_besu
        mode: "0755"

    - name: copy run_mist
      copy:
        src: ./files/run_mist
        dest: /usr/local/bin/run_mist
        mode: "0755"

    - name: set network
      lineinfile: 
        path: /etc/default/besu
        state: present
        regexp: "^NETWORK="
        line: "NETWORK={{ ethereum_network }}"

    - name: set network id
      lineinfile: 
        path: /etc/default/besu
        state: present
        regexp: "^NETWORK_ID="
        line: "NETWORK_ID={{ ethereum_network_id }}"

    - name: set private blockchain pwd
      lineinfile:
        path: /home/x2go/.ethereumpwd
        state: present
        create: yes
        owner: x2go
        group: users
        insertafter: EOF
        line: "{{ ethereum_password }}"

    - name: install truffle
      npm:
        name: truffle@latest
        global: yes

    - name: fugly visual studio fix - grrrr
      command: "sed -i 's/BIG-REQUESTS/_IG-REQUESTS/' /usr/lib/x86_64-linux-gnu/libxcb.so.1"
      args:
        warn: false
        
    - name: fire up besu
      systemd:
        name: besu
        masked: no
        enabled: yes
        state: started
        daemon_reload: yes
